<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Muslim Pro - Bastia Umbra</title>
    <style>
        :root { --green: #004F3F; --gold: #C5A059; --bg: #F6F7F9; }
        body { background-color: var(--bg); margin: 0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; transition: 0.5s; }
        body.night-mode { background-color: #00120f; color: white; }
        
        .header { width: 100%; background: var(--green); padding: 20px 0; text-align: center; border-bottom: 4px solid var(--gold); }
        .header h1 { color: var(--gold); margin: 0; }

        /* IL TASTO MAGICO PER L'AUDIO */
        #audio-unlocker {
            width: 90%; margin: 10px 0; padding: 15px;
            background: #ff4444; color: white; border: none;
            border-radius: 10px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #audio-unlocker.ready { background: #2ecc71; }

        .dashboard { width: 90%; display: flex; gap: 10px; margin-top: 10px; }
        .dash-card { flex: 1; background: white; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--gold); color: #333; }
        
        .prayer-list { width: 90%; margin-top: 20px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        .prayer-card { background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; border: 1px solid #ddd; color: #333; }
        .prayer-card.active { border: 2px solid var(--gold); background: #fffcf5; font-weight: bold; }

        .footer-news { width: 100%; background: var(--green); color: var(--gold); padding: 10px; text-align: center; font-size: 14px; position: fixed; bottom: 0; }
    </style>
</head>
<body>

    <audio id="sound-adhan" preload="auto" crossorigin="anonymous">
        <source src="https://ia800701.us.archive.org/34/items/Adhan_201704/Adhan%20Makkah.mp3">
    </audio>
    <audio id="sound-bip" preload="auto" crossorigin="anonymous">
        <source src="https://www.soundjay.com/buttons/beep-07a.mp3">
    </audio>

    <div class="header">
        <h1>Bastia Umbra - Ramadan</h1>
    </div>

    <button id="audio-unlocker" onclick="enableAudio()">⚠️ CLICCA QUI PER ATTIVARE AUDIO</button>

    <div class="dashboard">
        <div class="dash-card"><b>Data:</b> <div id="d-hijri">--</div></div>
        <div class="dash-card"><b>Prossima:</b> <div id="d-timer">--:--</div></div>
    </div>

    <div class="prayer-list" id="p-container"></div>

    <div class="footer-news" id="news-bar">Stato Moschea: In attesa...</div>

    <script>
        const audioAdhan = document.getElementById('sound-adhan');
        const audioBip = document.getElementById('sound-bip');
        let audioReady = false;

        // Funzione per sbloccare l'audio (Gesture Utente)
        function enableAudio() {
            audioAdhan.play().then(() => {
                audioAdhan.pause();
                audioAdhan.currentTime = 0;
                audioReady = true;
                const btn = document.getElementById('audio-unlocker');
                btn.innerText = "✅ AUDIO ATTIVATO";
                btn.className = "ready";
                setTimeout(() => btn.style.display = 'none', 2000); // Scompare dopo 2 secondi
            }).catch(e => alert("Errore: Clicca di nuovo!"));
        }

        // Funzione universale per suonare
        function triggerSound(isAdhan) {
            if (!audioReady) {
                console.log("Audio non sbloccato!");
                return;
            }
            const sound = isAdhan ? audioAdhan : audioBip;
            sound.currentTime = 0;
            sound.play().catch(e => console.log("Bloccato dal sistema"));
        }

        // --- DATI ---
        const times = { 
            "26/2": {f:"05:33", dh:"12:24", a:"15:26", m:"17:56", i:"19:15"},
            "27/2": {f:"05:31", dh:"12:24", a:"15:27", m:"17:57", i:"19:16"}
        };
        const pNames = { f:"Fajr", dh:"Dhuhr", a:"Asr", m:"Maghrib", i:"Isha" };

        function mainLoop() {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const dateKey = now.getDate() + "/" + (now.getMonth() + 1);
            const today = times[dateKey] || times["26/2"];

            // 1. IMSAK 05:20
            if (timeStr === "05:20" && window.lA !== "imsak") {
                window.lA = "imsak";
                triggerSound(false);
                alert("Imsak: Fine Suhoor!");
            }

            // 2. IFTAR 17:45
            if (timeStr === "17:45" && window.lA !== "iftar") {
                window.lA = "iftar";
                triggerSound(true);
            }

            // 3. TARAWIH 20:30
            if (timeStr === "20:30" && window.lA !== "tarawih") {
                window.lA = "tarawih";
                document.body.classList.add('night-mode');
                triggerSound(false);
            }

            // Orari Preghiera (Adhan)
            let html = "";
            for (let k in pNames) {
                if (timeStr === today[k] && window.lP !== k) {
                    window.lP = k;
                    triggerSound(true);
                }
                html += `<div class="prayer-card ${timeStr === today[k] ? 'active' : ''}">
                            <span>${pNames[k]}</span> <span>${today[k]}</span>
                         </div>`;
            }
            document.getElementById('p-container').innerHTML = html;
            document.getElementById('d-hijri').innerText = (dateKey === "26/2") ? "09 Ramadan" : "10 Ramadan";
        }

        // News Moschea
        async function getNews() {
            try {
                const r = await fetch('news.json?v=' + Date.now());
                const d = await r.json();
                document.getElementById('news-bar').innerText = "Moschea: " + d.text;
            } catch(e) {}
        }

        setInterval(mainLoop, 1000);
        setInterval(getNews, 30000);
        mainLoop();
        getNews();
    </script>
</body>
</html>
